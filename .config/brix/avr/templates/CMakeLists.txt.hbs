cmake_minimum_required(VERSION 3.10)

set(CMAKE_TOOLCHAIN_FILE "${CMAKE_SOURCE_DIR}/avr-gcc.toolchain.cmake")

enable_language(C ASM)

set(AVR_MCU "{{module}}")
set(AVR_CLOCK 16000000)

set(CMAKE_C_STANDARD 99)
set(CMAKE_C_STANDARD_REQUIRED ON)
set(CMAKE_C_EXTENSIONS OFF)
set(CMAKE_EXPORT_COMPILE_COMMANDS ON)

project("{{project}}" VERSION "1.0.0")

set(SOURCES_DIR     "${CMAKE_SOURCE_DIR}/src")

file(GLOB_RECURSE SRC_FILES         LIST_DIRECTORIES false "${SOURCES_DIR}/*.c")

string(TIMESTAMP    BUILD_TIMESTAMP "%Y-%m-%d %H:%M:%S UTC" UTC)

if(CMAKE_BUILD_TYPE MATCHES Debug)
    set(PROJECT_DEBUG "-dev")
endif()

execute_process(
    COMMAND             git log -n1 --format="%H"
    WORKING_DIRECTORY   ${CMAKE_CURRENT_SOURCE_DIR}
    OUTPUT_VARIABLE     PROJECT_BUILD_ID
)

string(REPLACE "\"" ""  PROJECT_BUILD_ID ${PROJECT_BUILD_ID})
string(REPLACE "\r" ""  PROJECT_BUILD_ID ${PROJECT_BUILD_ID})
string(REPLACE "\n" ""  PROJECT_BUILD_ID ${PROJECT_BUILD_ID})

configure_file("${SOURCES_DIR}/build.c.i" "${CMAKE_CURRENT_BINARY_DIR}/build.c" @ONLY)

include_directories(
    "inc/"
)

add_definitions(-DF_CPU=${AVR_CLOCK})
add_avr_executable(${PROJECT_NAME} ${AVR_MCU}
    ${SRC_FILES}
    "${CMAKE_CURRENT_BINARY_DIR}/build.c"
)
